<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Network Health &amp; Device Scanner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <header>
      <div class="header-row">
        <div class="title-group">
          <h1>Network Health &amp; Device Scanner</h1>
          <p class="tagline">Discover devices on your network, verify their status, and run quick connectivity tests.</p>
        </div>
        <button type="button" id="settings-toggle" class="icon-button" aria-label="Toggle settings" aria-controls="settings-card" aria-expanded="{{ 'true' if settings_visible else 'false' }}">‚öôÔ∏è</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h2>Run a Scan</h2>
        <form method="post" class="scan-form">
          <input type="hidden" name="form_type" value="scan" />
          <div class="field">
            <label for="cidr">CIDR</label>
            <input type="text" id="cidr" name="cidr" value="{{ form.cidr }}" placeholder="Auto-detect (e.g. 192.168.1.0/24)" />
          </div>
          <div class="field">
            <label for="concurrency">Concurrency</label>
            <input type="number" min="1" id="concurrency" name="concurrency" value="{{ form.concurrency }}" />
          </div>
          <div class="field">
            <label for="timeout">Ping Timeout (seconds)</label>
            <input type="number" step="0.1" min="0.1" id="timeout" name="timeout" value="{{ form.timeout }}" />
          </div>
          <div class="field">
            <label for="vendor_file">Vendor Map File</label>
            <input type="text" id="vendor_file" name="vendor_file" value="{{ form.vendor_file }}" placeholder="Optional path to JSON file" />
          </div>
          <div class="field">
            <label for="arp_timeout">ARP Timeout (seconds)</label>
            <input type="number" step="0.1" min="0.5" id="arp_timeout" name="arp_timeout" value="{{ form.arp_timeout }}" />
          </div>
          <div class="checkbox-group">
            <label class="checkbox">
              <input type="checkbox" name="vendor_remote" value="on" {% if form.vendor_remote %}checked{% endif %} />
              Enable vendor API lookups
            </label>
            <label class="checkbox">
              <input type="checkbox" name="vendor_refresh" value="on" {% if form.vendor_refresh %}checked{% endif %} />
              Force fresh vendor data
            </label>
          </div>
          <div class="actions">
            <button type="submit">Run Scan</button>
          </div>
        </form>
        {% if error %}
        <p class="message error">{{ error }}</p>
        {% endif %}
        <p class="meta">
          History entries stored: <strong>{{ history_size }}</strong>
          | Webhook notifications:
          {% if notifications_enabled %}
            <span class="badge on">Enabled</span>
          {% else %}
            <span class="badge off">Disabled</span>
          {% endif %}
        </p>
      </section>

      <section id="settings-card" class="card settings-card{% if settings_visible %} visible{% endif %}">
        <h2>Configuration</h2>
        {% if settings_message %}
        <p class="message success">{{ settings_message }}</p>
        {% endif %}
        {% if settings_error %}
        <p class="message error">{{ settings_error }}</p>
        {% endif %}
        <form method="post" class="settings-form">
          <input type="hidden" name="form_type" value="settings" />
          <div class="settings-grid">
            <div class="field">
              <label for="setting_default_cidr">Default CIDR</label>
              <input type="text" id="setting_default_cidr" name="setting_default_cidr" value="{{ settings_form.default_cidr }}" placeholder="Optional (e.g. 192.168.1.0/24)" />
            </div>
            <div class="field">
              <label for="setting_concurrency">Default Concurrency</label>
              <input type="number" min="1" id="setting_concurrency" name="setting_concurrency" value="{{ settings_form.concurrency }}" />
            </div>
            <div class="field">
              <label for="setting_timeout">Ping Timeout (seconds)</label>
              <input type="number" step="0.1" min="0.1" id="setting_timeout" name="setting_timeout" value="{{ settings_form.timeout }}" />
            </div>
            <div class="field">
              <label for="setting_arp_timeout">ARP Timeout (seconds)</label>
              <input type="number" step="0.1" min="0.1" id="setting_arp_timeout" name="setting_arp_timeout" value="{{ settings_form.arp_timeout }}" />
            </div>
            <div class="field">
              <label for="setting_history_max">History Limit</label>
              <input type="number" min="1" id="setting_history_max" name="setting_history_max" value="{{ settings_form.history_max }}" />
            </div>
            <div class="field">
              <label for="setting_history_path">History File Path</label>
              <input type="text" id="setting_history_path" name="setting_history_path" value="{{ settings_form.history_path }}" placeholder="Optional override" />
            </div>
          </div>

          <div class="checkbox-group">
            <label class="checkbox">
              <input type="checkbox" name="setting_vendor_remote" value="on" {% if settings_form.vendor_remote %}checked{% endif %} />
              Enable remote vendor lookup by default
            </label>
            <label class="checkbox">
              <input type="checkbox" name="setting_vendor_refresh" value="on" {% if settings_form.vendor_refresh %}checked{% endif %} />
              Force vendor refresh each scan
            </label>
            <label class="checkbox">
              <input type="checkbox" name="setting_webhook_enabled" value="on" {% if settings_form.webhook_enabled %}checked{% endif %} />
              Enable webhook notifications
            </label>
            <label class="checkbox">
              <input type="checkbox" name="setting_require_auth" value="on" {% if settings_form.require_auth %}checked{% endif %} />
              Require bearer token for web access
            </label>
          </div>

          <div class="settings-grid">
            <div class="field">
              <label for="setting_webhook_url">Webhook URL</label>
              <input type="url" id="setting_webhook_url" name="setting_webhook_url" value="{{ settings_form.webhook_url }}" placeholder="https://example.com/webhook" />
            </div>
            <div class="field">
              <label for="setting_webhook_secret">Webhook Secret Header</label>
              <input type="text" id="setting_webhook_secret" name="setting_webhook_secret" value="{{ settings_form.webhook_secret }}" placeholder="Optional shared secret" />
            </div>
            <div class="field">
              <label for="setting_webhook_timeout">Webhook Timeout (seconds)</label>
              <input type="number" step="0.5" min="1" id="setting_webhook_timeout" name="setting_webhook_timeout" value="{{ settings_form.webhook_timeout }}" />
            </div>
            <div class="field">
              <label for="setting_discord_webhook_url">Discord Webhook URL</label>
              <input type="url" id="setting_discord_webhook_url" name="setting_discord_webhook_url" value="{{ settings_form.discord_webhook_url }}" placeholder="https://discord.com/api/webhooks/..." />
            </div>
            <div class="field">
              <label for="setting_auth_token">Auth Token</label>
              <input type="text" id="setting_auth_token" name="setting_auth_token" value="{{ settings_form.auth_token }}" placeholder="Required when auth is enabled" />
            </div>
          </div>

          <div class="actions">
            <button type="submit">Save Settings</button>
          </div>
        </form>
      </section>

      {% if result %}
      <section class="card">
        <h2>Latest Scan</h2>
        <p class="meta">
          Network: <strong>{{ result.network }}</strong> |
          Started: <strong>{{ result.started_at.isoformat() }}Z</strong> |
          Duration: <strong>{{ '%.2f'|format(result.duration_s) }}s</strong> |
          Hosts: <strong>{{ result.devices|length }}</strong>
          {% if result.diagnostics.history %}
          | New: <strong>{{ result.diagnostics.history.new_devices|length }}</strong>
          | Missing: <strong>{{ result.diagnostics.history.missing_devices|length }}</strong>
          {% endif %}
        </p>
        {% if result.diagnostics %}
        <p class="meta secondary">
          ARP: {{ result.diagnostics.arp_method }} ({{ result.diagnostics.arp_entries }} entries) ‚Ä¢
          Vendor API: {{ 'On' if result.diagnostics.vendor_remote_enabled else 'Off' }} ‚Ä¢
          History size: {{ result.diagnostics.history.history_size if result.diagnostics.history else history_size }}
        </p>
        {% endif %}

        {% if changes %}
        <ul class="changes">
          {% if changes.new_devices %}
          <li>üÜï New devices: {{ changes.new_devices | join(', ') }}</li>
          {% endif %}
          {% if changes.returned_devices %}
          <li>‚úÖ Back online: {{ changes.returned_devices | join(', ') }}</li>
          {% endif %}
          {% if changes.missing_devices %}
          <li>‚ö†Ô∏è Missing this scan: {{ changes.missing_devices | join(', ') }}</li>
          {% endif %}
        </ul>
        {% endif %}

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>IP</th>
                <th>Name</th>
                <th>Hostname</th>
                <th>MAC</th>
                <th>Vendor</th>
                <th>Latency</th>
                <th>Status</th>
                <th>Tags</th>
                <th>Test</th>
              </tr>
            </thead>
            <tbody>
              {% for device in result.devices %}
              <tr data-ip="{{ device.ip }}">
                <td>{{ device.ip }}</td>
                <td>{{ device.alias_name or device.hostname or '‚Äî' }}</td>
                <td>{{ device.hostname or '‚Äî' }}</td>
                <td>{{ device.mac or '‚Äî' }}</td>
                <td>{{ device.vendor or 'Unknown' }}</td>
                <td>{{ device.latency_ms and ('%.1f ms'|format(device.latency_ms)) or '‚Äî' }}</td>
                <td>
                  {% if device.online %}
                  <span class="status online">üü¢ Online</span>
                  {% else %}
                  <span class="status offline">üî¥ Offline</span>
                  {% endif %}
                </td>
                <td>
                  {% set tags = device.tags or [] %}
                  {% if device.is_new %}
                    {% set tags = tags + ['üÜï New'] %}
                  {% endif %}
                  {{ tags|join(', ') if tags else '‚Äî' }}
                </td>
                <td>
                  <button class="ping-button" data-ip="{{ device.ip }}">Ping</button>
                  <span class="ping-result" id="ping-{{ device.ip|replace('.', '-') }}"></span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="actions secondary">
          <button id="download-json">Download JSON</button>
          <button id="download-csv">Download CSV</button>
        </div>
      </section>
      {% endif %}

      {% if history_entries %}
      <section class="card">
        <h2>Recent History</h2>
        <ul class="history-list">
          {% for entry in history_entries %}
          <li>
            <span class="history-time">{{ entry.started_at }}</span>
            <span class="history-summary">Devices: {{ entry.devices|length }} | Duration: {{ '%.2f'|format(entry.duration_s) }}s</span>
          </li>
          {% endfor %}
        </ul>
        <div class="actions secondary">
          <button id="download-history">Download Full History</button>
        </div>
      </section>
      {% endif %}
    </main>

    <footer>
      <p>Need automation? Use the <code>POST {{ api_url }}</code> endpoint to trigger scans programmatically.</p>
    </footer>

    <script>
      const settingsToggle = document.getElementById('settings-toggle');
      const settingsCard = document.getElementById('settings-card');
      if (settingsToggle && settingsCard) {
        const updateAria = () => settingsToggle.setAttribute('aria-expanded', settingsCard.classList.contains('visible') ? 'true' : 'false');
        settingsToggle.addEventListener('click', () => {
          settingsCard.classList.toggle('visible');
          updateAria();
        });
        updateAria();
      }

      const pingButtons = document.querySelectorAll('.ping-button');
      const downloadButton = document.getElementById('download-json');
      const downloadCsvButton = document.getElementById('download-csv');
      const downloadHistoryButton = document.getElementById('download-history');

      pingButtons.forEach((button) => {
        button.addEventListener('click', async (event) => {
          const ip = event.currentTarget.dataset.ip;
          const output = document.getElementById(`ping-${ip.replaceAll('.', '-')}`);
          output.textContent = 'Testing‚Ä¶';
          try {
            const response = await fetch('{{ url_for("ping_test") }}', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ip }),
            });
            const data = await response.json();
            if (!response.ok) {
              output.textContent = data.error || 'Ping failed';
              output.className = 'ping-result error';
              return;
            }
            output.className = 'ping-result ' + (data.online ? 'online' : 'offline');
            if (data.online) {
              const latency = data.latency_ms !== null ? `${data.latency_ms.toFixed(1)} ms` : '‚Äî';
              output.textContent = `Online (${latency})`;
            } else {
              output.textContent = 'Offline';
            }
          } catch (err) {
            output.textContent = 'Ping failed';
            output.className = 'ping-result error';
          }
        });
      });

      async function fetchLatestResult() {
        const response = await fetch('{{ url_for("api_last_scan") }}');
        if (!response.ok) {
          throw new Error('No scan data available yet.');
        }
        const payload = await response.json();
        return payload.result || payload;
      }

      const escapeCsv = (value) => {
        if (value === null || value === undefined) {
          return '';
        }
        const raw = Array.isArray(value) ? value.join('|') : String(value);
        if (/[",\n]/.test(raw)) {
          return '"' + raw.replaceAll('"', '""') + '"';
        }
        return raw;
      };

      if (downloadButton) {
        downloadButton.addEventListener('click', async () => {
          try {
            const data = await fetchLatestResult();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scan-result.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (err) {
            alert('Failed to download scan data.');
          }
        });
      }

      if (downloadCsvButton) {
        downloadCsvButton.addEventListener('click', async () => {
          try {
            const data = await fetchLatestResult();
            const devices = data.devices || [];
            const header = ['ip', 'alias_name', 'hostname', 'mac', 'vendor', 'latency_ms', 'online', 'is_new', 'tags'];
            const rows = [header.join(',')];
            devices.forEach((device) => {
              const tags = [...(device.tags || [])];
              if (device.is_new) {
                tags.push('üÜï New');
              }
              rows.push([
                device.ip,
                device.alias_name || '',
                device.hostname || '',
                device.mac || '',
                device.vendor || '',
                device.latency_ms !== null ? device.latency_ms : '',
                device.online,
                device.is_new || false,
                tags,
              ].map(escapeCsv).join(','));
            });
            const blob = new Blob([rows.join('\\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scan-result.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (err) {
            alert(err.message || 'Failed to download CSV.');
          }
        });
      }

      if (downloadHistoryButton) {
        downloadHistoryButton.addEventListener('click', async () => {
          try {
            const response = await fetch('{{ url_for("api_history") }}');
            if (!response.ok) {
              alert('History not available yet.');
              return;
            }
            const historyData = await response.json();
            const blob = new Blob([JSON.stringify(historyData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scan-history.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          } catch (err) {
            alert('Failed to download history.');
          }
        });
      }
    </script>
  </body>
</html>
